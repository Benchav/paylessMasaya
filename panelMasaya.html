<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Payless SUC Masaya — CRUD</title>
  <style>
    :root{
      --bg:#0f1724;
      --card:#0b1220;
      --accent:#ff6b35;
      --muted:#98a0b3;
      --glass: rgba(255,255,255,0.03);
      --success:#34d399;
      --danger:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;
      background:linear-gradient(180deg,#071029 0%, #0f1724 100%);color:#e6eef8;
    }
    .app{display:grid;grid-template-columns:300px 1fr;min-height:100vh;gap:24px;padding:28px;}
    .sidebar{
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:12px;padding:20px;box-shadow: 0 6px 18px rgba(2,6,23,0.6);
      border:1px solid rgba(255,255,255,0.03);
    }
    .brand{display:flex;align-items:center;gap:12px;margin-bottom:18px}
    .logo{width:44px;height:44px;border-radius:8px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:700;color:#071022}
    .brand h1{font-size:16px;margin:0}
    .brand p{margin:0;font-size:12px;color:var(--muted)}
    nav ul{list-style:none;padding:0;margin:14px 0}
    .muted{color:var(--muted);font-size:13px}

    /* main */
    main{padding:18px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.015));border:1px solid rgba(255,255,255,0.03);box-shadow:0 6px 20px rgba(2,6,23,0.5)}
    header.main-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    .search{display:flex;gap:8px;align-items:center}
    .search input{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:10px;color:inherit}

    .controls{display:flex;gap:8px;align-items:center}
    .btn{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;cursor:pointer;color:inherit}
    .btn.primary{background:linear-gradient(90deg,var(--accent),#ff8a5b);color:#071022;border:none}
    .btn.warn{background:linear-gradient(90deg,#ffd89b,#ffb36b);color:#071022;border:none}
    .btn.danger{background:linear-gradient(90deg,#ff9b9b,#ff6b6b);color:#071022;border:none}

    .cards{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:18px}
    .card{padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.02)}
    .card h3{margin:0;font-size:13px;color:var(--muted)}
    .card p{margin:8px 0 0;font-size:18px;font-weight:600}

    .panel{display:flex;gap:16px}
    .left{flex:2}
    .right{flex:1}

    table{width:100%;border-collapse:collapse;background:transparent}
    th,td{padding:10px 8px;text-align:left;border-bottom:1px dashed rgba(255,255,255,0.03);font-size:14px}
    th{color:var(--muted);font-weight:600}
    tbody tr:hover{background:rgba(255,255,255,0.01)}

    form.fieldset{display:flex;flex-direction:column;gap:8px;padding:12px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));border:1px solid rgba(255,255,255,0.02)}
    .form-row{display:flex;gap:8px}
    .form-row input{flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}

    .msg{height:18px;font-size:13px;margin-top:8px;color:var(--muted)}

    @media (max-width:1000px){
      .app{grid-template-columns:1fr;}
      .panel{flex-direction:column;}
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">PS</div>
        <div>
          <h1>Payless SUC Masaya — Admin</h1>
          <p class="muted">CRUD — Masaya</p>
        </div>
      </div>
      <nav>
        <ul>
          <li class="muted">Sucursales</li>
          <li>
            <div class="branch-btn" data-branch="jinotepe" onclick="window.location.href='https://jinotepe.proyect.site/'">
              <div class="branch-name"><strong>Jinotepe</strong></div>
            </div>
          </li>
          <li>
            <div class="branch-btn" data-branch="chontales" onclick="window.location.href='https://chontales.proyect.site/'">
              <div class="branch-name"><strong>Chontales</strong></div>
            </div>
          </li>
          <li>
            <div class="branch-btn" data-branch="masaya" onclick="window.location.href='https://masaya.proyect.site/'">
              <div class="branch-name"><strong>Masaya</strong></div>
            </div>
          </li>
        </ul>
      </nav>

      <div style="margin-top:18px">
        <div class="muted" style="margin-bottom:8px">Acciones rápidas</div>
        <button class="btn" onclick="downloadAll()">Exportar CSV</button>
        <button class="btn" style="margin-top:8px" onclick="logout()">Cerrar sesión</button>
        <div class="msg" id="sideMsg"></div>
      </div>
    </aside>

    <main>
      <header class="main-header">
        <div>
          <h2 style="margin:0">Panel administrativo — Masaya</h2>
          <div class="muted">Gestión completa de productos (CRUD)</div>
        </div>

        <div class="controls">
          <div class="search">
            <input id="searchInput" placeholder="Buscar por nombre, marca o tamaño" oninput="filterTable()" />
          </div>
          <button class="btn" onclick="refreshData()">Actualizar</button>
        </div>
      </header>

      <section class="cards">
        <div class="card"><h3>Productos</h3><p id="countProducts">0</p></div>
        <div class="card"><h3>Valor total</h3><p id="totalValue">$0.00</p></div>
        <div class="card"><h3>Stock crítico (≤5)</h3><p id="stockCritical">0</p></div>
      </section>

      <section class="panel">
        <div class="left">
          <!-- CRUD Table -->
          <div style="overflow:auto;border-radius:10px;background:transparent;padding:6px">
            <table id="recordsTable">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Marca</th>
                  <th>Tamaño</th>
                  <th>Precio</th>
                  <th>Stock</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <aside class="right">
          <!-- Create / Edit form -->
          <form id="productForm" class="fieldset">
            <h3 style="margin:0">Crear / Editar producto</h3>

            <div class="form-row">
              <input id="f_name" placeholder="Nombre" required />
            </div>
            <div class="form-row">
              <input id="f_brand" placeholder="Marca" required />
            </div>
            <div class="form-row">
              <input id="f_size" placeholder="Tamaño (ej. 42)" type="number" min="0" required />
              <input id="f_price" placeholder="Precio" type="number" step="0.01" min="0" required />
            </div>
            <div class="form-row">
              <input id="f_stock" placeholder="Stock" type="number" min="0" required />
            </div>

            <div style="display:flex;gap:8px;margin-top:6px">
              <button id="saveBtn" class="btn primary" type="button">Guardar</button>
              <button id="cancelEdit" class="btn" type="button">Cancelar</button>
            </div>

            <div class="msg" id="formMsg"></div>
          </form>
        </aside>
      </section>
    </main>
  </div>

  <script>
    // CONFIG
    const API_BASE = 'https://payless-api.vercel.app';
    const RESOURCE = '/api/masaya';
    const STORAGE_AUTH = 'payless_auth_v1';

    // state
    let editingId = null;
    let rowsCache = [];

    // auth
    const auth = JSON.parse(localStorage.getItem(STORAGE_AUTH));
    const token = auth?.token;
    if(!token) {
      window.location.href = 'index.html';
    }

    // helpers for messages
    function showFormMsg(text, ok=true){
      const el = document.getElementById('formMsg');
      el.textContent = text;
      el.style.color = ok ? 'var(--success)' : 'var(--danger)';
    }
    function showSideMsg(text, ok=true){
      const el = document.getElementById('sideMsg');
      el.textContent = text;
      el.style.color = ok ? 'var(--success)' : 'var(--danger)';
      setTimeout(()=> el.textContent = '', 4000);
    }

    // fetch wrapper
    async function apiFetch(path, opts = {}) {
      const headers = Object.assign({'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token}, opts.headers || {});
      const res = await fetch(API_BASE + path, Object.assign({}, opts, { headers }));
      const text = await res.text().catch(()=>null);
      let data = null;
      try { data = text ? JSON.parse(text) : null; } catch(e){ data = text; }
      if(!res.ok){
        const msg = (data && data.message) || `Error ${res.status}`;
        const err = new Error(msg);
        err.status = res.status;
        err.body = data;
        throw err;
      }
      return data;
    }

    // CRUD functions
    async function fetchRecords(){
      try {
        const data = await apiFetch(RESOURCE, { method: 'GET' });
        rowsCache = Array.isArray(data) ? data : (data?.items || []);
        return rowsCache;
      } catch(err){
        console.error('fetchRecords error', err);
        showSideMsg('No se pudieron cargar los registros. Revisa tu token o login.', false);
        return [];
      }
    }

    async function createRecord(payload){
      return await apiFetch(RESOURCE, { method: 'POST', body: JSON.stringify(payload) });
    }

    async function updateRecord(id, payload){
      return await apiFetch(`${RESOURCE}/${encodeURIComponent(id)}`, { method: 'PUT', body: JSON.stringify(payload) });
    }

    async function deleteRecord(id){
      return await apiFetch(`${RESOURCE}/${encodeURIComponent(id)}`, { method: 'DELETE' });
    }

    // UI render
    function renderTable(rows){
      const tbody = document.querySelector('#recordsTable tbody');
      tbody.innerHTML = '';
      rows.forEach(r=>{
        const id = r.id || r._id || r.docId || r.key || '';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(r.name || '')}</td>
          <td>${escapeHtml(r.brand || '')}</td>
          <td>${escapeHtml(String(r.size ?? ''))}</td>
          <td>$${Number(r.price ?? 0).toFixed(2)}</td>
          <td>${Number(r.stock ?? 0)}</td>
          <td>
            <button class="btn" data-id="${id}">Editar</button>
            <button class="btn danger" data-id="${id}">Borrar</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      document.getElementById('countProducts').innerText = rows.length;
      // delegate actions
      tbody.querySelectorAll('button').forEach(btn=>{
        const id = btn.getAttribute('data-id');
        if(btn.textContent.trim() === 'Editar') btn.addEventListener('click',()=> onEdit(id));
        if(btn.textContent.trim() === 'Borrar') btn.addEventListener('click',()=> onDelete(id));
      });
    }

    function updateCards(rows){
      const totalValue = rows.reduce((s,r) => s + Number(r.price || 0), 0);
      const critical = rows.filter(r => Number(r.stock || 0) <= 5).length;
      document.getElementById('totalValue').innerText = `$${totalValue.toFixed(2)}`;
      document.getElementById('stockCritical').innerText = critical;
    }

    // form helpers
    function resetForm(){
      editingId = null;
      document.getElementById('productForm').reset();
      showFormMsg('');
      document.getElementById('saveBtn').textContent = 'Guardar';
    }

    function fillFormWith(record){
      document.getElementById('f_name').value = record.name || '';
      document.getElementById('f_brand').value = record.brand || '';
      document.getElementById('f_size').value = record.size ?? '';
      document.getElementById('f_price').value = record.price ?? '';
      document.getElementById('f_stock').value = record.stock ?? '';
      showFormMsg('');
      document.getElementById('saveBtn').textContent = 'Actualizar';
    }

    // actions
    async function onSaveClick(){
      const btn = document.getElementById('saveBtn');
      const payload = {
        name: document.getElementById('f_name').value.trim(),
        brand: document.getElementById('f_brand').value.trim(),
        size: Number(document.getElementById('f_size').value || 0),
        price: Number(document.getElementById('f_price').value || 0),
        stock: Number(document.getElementById('f_stock').value || 0)
      };
      if(!payload.name || !payload.brand){ showFormMsg('Nombre y Marca son obligatorios', false); return; }

      btn.disabled = true;
      try {
        if(editingId){
          await updateRecord(editingId, payload);
          showFormMsg('Actualizado correctamente', true);
        } else {
          await createRecord(payload);
          showFormMsg('Creado correctamente', true);
        }
        await refreshAndRender();
        resetForm();
      } catch(err){
        console.error('save error', err);
        showFormMsg(err.message || 'Error al guardar', false);
      } finally {
        btn.disabled = false;
      }
    }

    async function onEdit(id){
      if(!id){ showSideMsg('Id no encontrado', false); return; }
      const rec = rowsCache.find(r => (r.id === id || r._id === id || String(r.docId) === id || r.key === id));
      if(rec){
        editingId = id;
        fillFormWith(rec);
        window.scrollTo({top:0,behavior:'smooth'});
        return;
      }
      // fallback refetch
      showSideMsg('Registro no encontrado en caché. Actualizando...', true);
      await refreshAndRender();
      onEdit(id);
    }

    async function onDelete(id){
      if(!id){ showSideMsg('Id no encontrado', false); return; }
      if(!confirm('¿Eliminar este producto? Esta acción no se puede deshacer.')) return;
      try {
        await deleteRecord(id);
        showSideMsg('Eliminado correctamente', true);
        await refreshAndRender();
      } catch(err){
        console.error('delete error', err);
        showSideMsg(err.message || 'Error al eliminar', false);
      }
    }

    // refresh + render
    async function refreshAndRender(){
      const rows = await fetchRecords();
      renderTable(rows);
      updateCards(rows);
    }

    function refreshData(){ refreshAndRender(); }

    // CSV
    async function downloadAll(){
      const rows = await fetchRecords();
      const header = ['name','brand','size','price','stock'];
      const csv = [header.join(','), ...rows.map(r => `${escapeCsv(r.name)},${escapeCsv(r.brand)},${r.size||''},${r.price||0},${r.stock||0}`)].join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'masaya_products.csv'; a.click(); URL.revokeObjectURL(url);
    }

    function logout(){ localStorage.removeItem(STORAGE_AUTH); window.location.href = 'index.html'; }

    // search filter
    function filterTable(){
      const q = document.getElementById('searchInput').value.toLowerCase();
      const filtered = rowsCache.filter(r=>{
        const hay = `${r.name||''} ${r.brand||''} ${r.size||''}`.toLowerCase();
        return hay.includes(q);
      });
      renderTable(filtered);
      updateCards(filtered);
    }

    // safe helpers
    function escapeHtml(s){ return String(s || '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
    function escapeCsv(s){ if(s==null) return ''; return `"${String(s).replaceAll('"','""')}"`; }

    // init
    (function init(){
      // attach handlers (only once)
      document.getElementById('saveBtn').addEventListener('click', onSaveClick);
      document.getElementById('cancelEdit').addEventListener('click', resetForm);
      // initial load
      refreshAndRender();
      // expose selectBranch for parity with other pages
      window.selectBranch = function(name){ showSideMsg(`Sucursal seleccionada: ${name}`, true); };
    })();
  </script>
</body>
</html>